<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Logs Explorer - 9to5-Scout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <script src="/assets/navigation.js" defer></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body class="bg-gray-50">
  <nav class="bg-white border-gray-200 dark:bg-gray-900 sticky top-0 z-50 shadow-sm">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="/" class="flex items-center space-x-3 rtl:space-x-reverse">
        <span class="text-2xl">üîç</span>
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">9to5-Scout</span>
      </a>
      <button data-collapse-toggle="navbar-default" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/>
        </svg>
      </button>
      <div class="hidden w-full md:block md:w-auto" id="navbar-default">
        <ul data-nav="primary" class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700"></ul>
      </div>
    </div>
  </nav>

  <main class="max-w-screen-xl mx-auto px-4 py-8 space-y-8">
    <header class="bg-white shadow rounded-lg p-6">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">System Logs Explorer</h1>
      <p class="text-gray-600">Search and analyze logs generated by Cloudflare Workers and Python scraping clients. All entries are retained for 30 days for full transparency.</p>
      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-end">
        <label class="flex-1 min-w-[220px]">
          <span class="block text-sm font-medium text-gray-700">API Token</span>
          <input id="api-token" type="password" placeholder="Bearer token for authenticated endpoints" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" autocomplete="off" />
        </label>
        <div class="flex items-center gap-2">
          <button id="toggle-token" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Show</button>
          <button id="apply-token" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Apply token</button>
        </div>
      </div>
      <p id="token-status" class="mt-2 text-sm text-gray-600">Provide a valid API token to access log metadata and entries.</p>
    </header>

    <section class="bg-white shadow rounded-lg p-6 space-y-6">
      <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
        <span>Advanced Filters</span>
        <span class="text-sm font-normal text-gray-500">Use combinations of text search, filters, and ordering to inspect activity.</span>
      </h2>
      <form id="filters-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label for="search" class="block text-sm font-medium text-gray-700">Full-text search</label>
            <input type="text" id="search" name="search" placeholder="Search message or payload..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
          </div>
          <div>
            <label for="sources" class="block text-sm font-medium text-gray-700">Sources</label>
            <select id="sources" name="sources" multiple class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-32"></select>
            <p class="text-xs text-gray-500 mt-1">Hold Ctrl/‚åò to select multiple sources.</p>
          </div>
          <div>
            <label for="levels" class="block text-sm font-medium text-gray-700">Log levels</label>
            <select id="levels" name="levels" multiple class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-32"></select>
          </div>
          <div>
            <label for="start" class="block text-sm font-medium text-gray-700">Start time</label>
            <input type="datetime-local" id="start" name="start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
          </div>
          <div>
            <label for="end" class="block text-sm font-medium text-gray-700">End time</label>
            <input type="datetime-local" id="end" name="end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
          </div>
          <div>
            <label for="request-id" class="block text-sm font-medium text-gray-700">Request ID</label>
            <input type="text" id="request-id" name="request-id" placeholder="Trace or request identifier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
          </div>
          <div>
            <label for="has-payload" class="block text-sm font-medium text-gray-700">Payload filter</label>
            <select id="has-payload" name="has-payload" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">Any</option>
              <option value="true">Has payload</option>
              <option value="false">Empty payload</option>
            </select>
          </div>
          <div>
            <label for="order-by" class="block text-sm font-medium text-gray-700">Order by</label>
            <select id="order-by" name="order-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="timestamp">Timestamp</option>
              <option value="log_level">Log level</option>
              <option value="source">Source</option>
              <option value="created_at">Created at</option>
            </select>
          </div>
          <div>
            <label for="order-direction" class="block text-sm font-medium text-gray-700">Order direction</label>
            <select id="order-direction" name="order-direction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="desc">Newest first</option>
              <option value="asc">Oldest first</option>
            </select>
          </div>
          <div>
            <label for="limit" class="block text-sm font-medium text-gray-700">Page size</label>
            <select id="limit" name="limit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="250">250</option>
            </select>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Apply filters</button>
          <button type="button" id="reset-filters" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Reset</button>
          <span id="filters-summary" class="text-sm text-gray-500"></span>
        </div>
      </form>
    </section>

    <section class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-semibold text-gray-900">Log entries</h2>
          <p class="text-sm text-gray-500">Showing <span id="results-range">0</span> of <span id="results-total">0</span> entries</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="prev-page" class="px-3 py-2 text-sm rounded border border-gray-300 text-gray-600 bg-white hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
          <button id="next-page" class="px-3 py-2 text-sm rounded border border-gray-300 text-gray-600 bg-white hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payload</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request ID</th>
            </tr>
          </thead>
          <tbody id="logs-table" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
        </table>
      </div>
      <div id="empty-state" class="hidden text-center py-10 text-gray-500">No log entries match the selected filters.</div>
    </section>
  </main>

  <script>
  (function() {
    const TOKEN_STORAGE_KEY = 'logsExplorerToken';
    const FALLBACK_TOKEN_KEY = 'operationsDashboardToken';

    const state = {
      offset: 0,
      limit: 50,
      total: 0,
      hasNext: false,
      currentFilters: {},
      token: ''
    };

    const tokenInput = document.getElementById('api-token');
    const toggleTokenButton = document.getElementById('toggle-token');
    const applyTokenButton = document.getElementById('apply-token');
    const tokenStatus = document.getElementById('token-status');
    const sourcesSelect = document.getElementById('sources');
    const levelsSelect = document.getElementById('levels');
    const resultsTotal = document.getElementById('results-total');
    const resultsRange = document.getElementById('results-range');
    const logsTable = document.getElementById('logs-table');
    const emptyState = document.getElementById('empty-state');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const filtersSummary = document.getElementById('filters-summary');
    const limitSelect = document.getElementById('limit');

    function setTokenStatus(message, tone = 'info') {
      const toneClasses = {
        info: 'mt-2 text-sm text-gray-600',
        success: 'mt-2 text-sm text-green-600',
        warning: 'mt-2 text-sm text-yellow-600',
        error: 'mt-2 text-sm text-red-600'
      };
      tokenStatus.className = toneClasses[tone] || toneClasses.info;
      tokenStatus.textContent = message;
    }

    function updateToken(newToken) {
      state.token = newToken.trim();
      if (state.token) {
        localStorage.setItem(TOKEN_STORAGE_KEY, state.token);
      } else {
        localStorage.removeItem(TOKEN_STORAGE_KEY);
      }
      setTokenStatus(
        state.token
          ? 'Token stored locally. Requests will include Authorization headers.'
          : 'Provide a valid API token to access log metadata and entries.',
        state.token ? 'success' : 'warning'
      );
    }

    function loadPersistedToken() {
      const stored = localStorage.getItem(TOKEN_STORAGE_KEY) || localStorage.getItem(FALLBACK_TOKEN_KEY) || '';
      if (stored) {
        state.token = stored.trim();
        tokenInput.value = state.token;
        localStorage.setItem(TOKEN_STORAGE_KEY, state.token);
        setTokenStatus('Token loaded from storage. You can refresh data now.', 'success');
      } else {
        setTokenStatus('Provide a valid API token to access log metadata and entries.', 'warning');
      }
    }

    async function authorizedFetch(path, init = {}) {
      if (!state.token) {
        const error = new Error('Missing token');
        error.code = 'MISSING_TOKEN';
        throw error;
      }

      const headers = new Headers(init.headers || {});
      headers.set('Authorization', `Bearer ${state.token}`);
      if (!headers.has('Accept')) {
        headers.set('Accept', 'application/json');
      }

      const response = await fetch(path, { ...init, headers });

      if (response.status === 401) {
        const error = new Error('Unauthorized');
        error.code = 'UNAUTHORIZED';
        error.response = response;
        throw error;
      }

      if (!response.ok) {
        const error = new Error(`HTTP ${response.status}`);
        error.code = 'HTTP_ERROR';
        error.response = response;
        throw error;
      }

      return response;
    }

    function handleAuthError(error) {
      if (!error) {
        return;
      }
      if (error.code === 'MISSING_TOKEN') {
        setTokenStatus('Provide a valid API token to access log metadata and entries.', 'warning');
        return;
      }
      if (error.code === 'UNAUTHORIZED') {
        setTokenStatus('API token was rejected. Please verify the token and try again.', 'error');
        return;
      }
      console.error('Logs request failed:', error);
      setTokenStatus('Failed to load logs data. Check console for details.', 'error');
    }

    function option(value, label) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      return opt;
    }

    function populateSelect(select, values) {
      select.innerHTML = '';
      values.forEach((value) => {
        select.appendChild(option(value, value));
      });
    }

    function toIso(input) {
      if (!input) return null;
      const date = new Date(input);
      if (Number.isNaN(date.getTime())) return null;
      return date.toISOString();
    }

    function buildQuery(params) {
      const searchParams = new URLSearchParams();
      Object.entries(params).forEach(([key, value]) => {
        if (value === null || value === undefined || value === '') {
          return;
        }
        if (Array.isArray(value) && value.length === 0) {
          return;
        }
        if (Array.isArray(value)) {
          searchParams.set(key, value.join(','));
        } else {
          searchParams.set(key, value);
        }
      });
      return searchParams;
    }

    function summarizeFilters(params) {
      const active = [];
      if (params.search) active.push(`search:"${params.search}"`);
      if (params.source && params.source.length) active.push(`sources:${params.source.length}`);
      if (params.log_level && params.log_level.length) active.push(`levels:${params.log_level.join('|')}`);
      if (params.start) active.push('from:custom');
      if (params.end) active.push('to:custom');
      if (params.request_id) active.push(`request:${params.request_id}`);
      if (params.has_payload !== undefined && params.has_payload !== null && params.has_payload !== '') active.push(`payload:${params.has_payload}`);
      filtersSummary.textContent = active.length ? `Active filters ‚Äî ${active.join(', ')}` : 'No active filters';
    }

    function renderPayload(value) {
      if (value === null || value === undefined || value === '') {
        return '<span class="text-gray-400">‚Äî</span>';
      }
      if (typeof value === 'string') {
        return `<pre class="whitespace-pre-wrap text-xs text-gray-700">${value.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]))}</pre>`;
      }
      try {
        return `<pre class="whitespace-pre-wrap text-xs text-gray-700">${JSON.stringify(value, null, 2)}</pre>`;
      } catch (err) {
        return `<span class="text-gray-500">[unrenderable payload]</span>`;
      }
    }

    function renderLogs(logs, offset, limit, total) {
      logsTable.innerHTML = '';
      if (!logs || logs.length === 0) {
        emptyState.classList.remove('hidden');
        resultsRange.textContent = '0';
        resultsTotal.textContent = total;
        prevButton.disabled = offset === 0;
        nextButton.disabled = true;
        return;
      }

      emptyState.classList.add('hidden');
      logs.forEach((log) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">${new Date(log.timestamp || log.created_at).toLocaleString()}</td>
          <td class="px-4 py-3 text-sm font-medium text-gray-700">${log.source}</td>
          <td class="px-4 py-3 text-xs font-semibold uppercase ${log.log_level === 'ERROR' || log.log_level === 'CRITICAL' ? 'text-red-600' : log.log_level === 'WARNING' ? 'text-yellow-600' : 'text-gray-600'}">${log.log_level}</td>
          <td class="px-4 py-3 text-sm text-gray-700 whitespace-pre-wrap">${log.message ? log.message.replace(/[&<>]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) : '<span class="text-gray-400">‚Äî</span>'}</td>
          <td class="px-4 py-3 text-sm">${renderPayload(log.json_payload)}</td>
          <td class="px-4 py-3 text-xs text-gray-500">${log.request_id || '‚Äî'}</td>
        `;
        logsTable.appendChild(row);
      });

      const startIndex = offset + 1;
      const endIndex = Math.min(offset + logs.length, total);
      resultsRange.textContent = `${startIndex}-${endIndex}`;
      resultsTotal.textContent = total;

      prevButton.disabled = offset === 0;
      nextButton.disabled = endIndex >= total;
    }

    async function fetchMeta() {
      if (!state.token) {
        setTokenStatus('Provide a valid API token to access log metadata and entries.', 'warning');
        return;
      }
      try {
        const response = await authorizedFetch('/api/logs/meta');
        const data = await response.json();
        populateSelect(sourcesSelect, data.sources || []);
        populateSelect(levelsSelect, data.levels || []);
      } catch (error) {
        handleAuthError(error);
        throw error;
      }
    }

    async function fetchLogs() {
      if (!state.token) {
        setTokenStatus('Provide a valid API token to access log metadata and entries.', 'warning');
        return;
      }
      const params = {
        search: document.getElementById('search').value.trim() || undefined,
        source: Array.from(sourcesSelect.selectedOptions).map((opt) => opt.value),
        log_level: Array.from(levelsSelect.selectedOptions).map((opt) => opt.value),
        start: toIso(document.getElementById('start').value || null),
        end: toIso(document.getElementById('end').value || null),
        request_id: document.getElementById('request-id').value.trim() || undefined,
        has_payload: document.getElementById('has-payload').value || undefined,
        order_by: document.getElementById('order-by').value,
        order_direction: document.getElementById('order-direction').value,
        limit: state.limit,
        offset: state.offset
      };

      summarizeFilters(params);

      const searchParams = buildQuery(params);
      try {
        const response = await authorizedFetch(`/api/logs?${searchParams.toString()}`);
        const data = await response.json();
        state.total = data.total || 0;
        state.hasNext = state.offset + state.limit < state.total;
        renderLogs(data.logs || [], state.offset, state.limit, state.total);
      } catch (error) {
        handleAuthError(error);
        throw error;
      }
    }

    document.getElementById('filters-form').addEventListener('submit', (event) => {
      event.preventDefault();
      state.offset = 0;
      state.limit = parseInt(limitSelect.value, 10) || 50;
      fetchLogs().catch(() => {});
    });

    document.getElementById('reset-filters').addEventListener('click', () => {
      document.getElementById('filters-form').reset();
      Array.from(sourcesSelect.options).forEach((opt) => (opt.selected = false));
      Array.from(levelsSelect.options).forEach((opt) => (opt.selected = false));
      state.offset = 0;
      state.limit = 50;
      limitSelect.value = '50';
      fetchLogs().catch(() => {});
    });

    prevButton.addEventListener('click', () => {
      if (state.offset === 0) return;
      state.offset = Math.max(state.offset - state.limit, 0);
      fetchLogs().catch(() => {});
    });

    nextButton.addEventListener('click', () => {
      if (!state.hasNext) return;
      state.offset += state.limit;
      fetchLogs().catch(() => {});
    });

    limitSelect.addEventListener('change', () => {
      state.limit = parseInt(limitSelect.value, 10) || 50;
      state.offset = 0;
      fetchLogs().catch(() => {});
    });

    tokenInput.addEventListener('input', (event) => {
      updateToken(event.target.value);
    });

    tokenInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        applyTokenButton.click();
      }
    });

    toggleTokenButton.addEventListener('click', () => {
      const currentType = tokenInput.getAttribute('type');
      const nextType = currentType === 'password' ? 'text' : 'password';
      tokenInput.setAttribute('type', nextType);
      toggleTokenButton.textContent = nextType === 'password' ? 'Show' : 'Hide';
    });

    applyTokenButton.addEventListener('click', () => {
      updateToken(tokenInput.value);
      if (state.token) {
        fetchMeta()
          .then(() => fetchLogs())
          .catch(() => {});
      }
    });

    loadPersistedToken();
    if (state.token) {
      fetchMeta()
        .then(() => fetchLogs())
        .catch(() => {});
    }
  })();
  </script>
</body>
</html>
